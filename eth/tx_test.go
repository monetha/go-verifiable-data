package eth

import (
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/rlp"
)

func TestTransaction_GetSenderPublicKey(t *testing.T) {
	for txRlp, addr := range map[string]string{
		"f864808504a817c800825208943535353535353535353535353535353535353535808025a0044852b2a670ade5407e78fb2863c51de9fcb96542a07186fe3aeda6bb8a116da0044852b2a670ade5407e78fb2863c51de9fcb96542a07186fe3aeda6bb8a116d":       "0xf0f6f18bca1b28cd68e4357452947e021241e9ce",
		"f864018504a817c80182a410943535353535353535353535353535353535353535018025a0489efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bcaa0489efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc6":       "0x23ef145a395ea3fa3deb533b8a9e1b4c6c25d112",
		"f864028504a817c80282f618943535353535353535353535353535353535353535088025a02d7c5bef027816a800da1736444fb58a807ef4c9603b7848673f7e3a68eb14a5a02d7c5bef027816a800da1736444fb58a807ef4c9603b7848673f7e3a68eb14a5":       "0x2e485e0c23b4c3c542628a5f672eeab0ad4888be",
		"f865038504a817c803830148209435353535353535353535353535353535353535351b8025a02a80e1ef1d7842f27f2e6be0972bb708b9a135c38860dbe73c27c3486c34f4e0a02a80e1ef1d7842f27f2e6be0972bb708b9a135c38860dbe73c27c3486c34f4de":     "0x82a88539669a3fd524d669e858935de5e5410cf0",
		"f865048504a817c80483019a28943535353535353535353535353535353535353535408025a013600b294191fc92924bb3ce4b969c1e7e2bab8f4c93c3fc6d0a51733df3c063a013600b294191fc92924bb3ce4b969c1e7e2bab8f4c93c3fc6d0a51733df3c060":     "0xf9358f2538fd5ccfeb848b64a96b743fcc930554",
		"f865058504a817c8058301ec309435353535353535353535353535353535353535357d8025a04eebf77a833b30520287ddd9478ff51abbdffa30aa90a8d655dba0e8a79ce0c1a04eebf77a833b30520287ddd9478ff51abbdffa30aa90a8d655dba0e8a79ce0c1":     "0xa8f7aba377317440bc5b26198a363ad22af1f3a4",
		"f866068504a817c80683023e3894353535353535353535353535353535353535353581d88025a06455bf8ea6e7463a1046a0b52804526e119b4bf5136279614e0b1e8e296a4e2fa06455bf8ea6e7463a1046a0b52804526e119b4bf5136279614e0b1e8e296a4e2d":   "0xf1f571dc362a0e5b2696b8e775f8491d3e50de35",
		"f867078504a817c807830290409435353535353535353535353535353535353535358201578025a052f1a9b320cab38e5da8a8f97989383aab0a49165fc91c737310e4f7e9821021a052f1a9b320cab38e5da8a8f97989383aab0a49165fc91c737310e4f7e9821021": "0xd37922162ab7cea97c97a87551ed02c9a38b7332",
		"f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10": "0x9bddad43f934d313c2b79ca28a432dd2b7281029",
		"f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb": "0x3c24d7329e92f84f08556ceb6df1cdb0104ca49f",
		"f85d808080947dff54ea50be2b191ffc2149b3c931966b6a4e5a80801ca008b479ce8093ec1e408fef29f083fca0e047f5eaa77f50b9dc667618c7313ed6a05775695011fad6e64385314dcb61f7f1de5c00e9d73d5f2b15462776c5b7b7f1":                     "0x7dff54ea50be2b191ffc2149b3c931966b6a4e5a",
		"f85d80808094581a8318cba8d1063ed09d99bc80d9e19d30b491808078a03f6839ac3f88857630342b030fd54d85abe8b88d8edca3b834f96af8f268b876a0525ee9f52ef53e099b8facda74ae1777be645bc3153481021a6e5b94aaf8f06d":                     "0x581a8318cba8d1063ed09d99bc80d9e19d30b491",
	} {
		expectedAddress := common.HexToAddress(addr)

		var tx *types.Transaction
		err := rlp.DecodeBytes(common.Hex2Bytes(txRlp), &tx)
		if err != nil {
			t.Errorf("%v: %v", txRlp, err)
			continue
		}

		pubKey, err := (*Transaction)(tx).GetSenderPublicKey()
		if err != nil {
			t.Errorf("%v: %v", txRlp, err)
			continue
		}

		pubKeyAddress := crypto.PubkeyToAddress(*pubKey)

		if pubKeyAddress != expectedAddress {
			t.Errorf("%v: expected %v got %v", txRlp, expectedAddress.String(), pubKeyAddress.String())
		}
	}
}
